{% extends "admin/base.html" %}

{% block title %}{{ "แก้ไขเมนู" if edit else "เพิ่มเมนูใหม่" }}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        font-size: 16px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid #ddd;
    }
    
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .file-input-wrapper:hover {
        background: #e9ecef;
    }
    
    .file-input-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        transition: transform 0.2s;
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .required {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">{{ "แก้ไขเมนู" if edit else "เพิ่มเมนูใหม่" }}</h1>
            <p class="text-muted">{{ menu.name if edit else "กรอกข้อมูลเมนูใหม่" }}</p>
        </div>
        <a href="{{ url_for('admin.menu_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> กลับ
        </a>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="form-container">
                <form method="POST" enctype="multipart/form-data" id="menuForm">
                    <!-- Basic Information -->
                    <h5 class="mb-3">ข้อมูลพื้นฐาน</h5>
                    
                    <div class="form-group">
                        <label for="name" class="form-label">
                            ชื่อเมนู <span class="required">*</span>
                        </label>
                        <input type="text" 
                               id="name" 
                               name="name" 
                               class="form-control" 
                               value="{{ menu.name if edit else '' }}"
                               placeholder="เช่น ผัดไทยกุ้ง"
                               required>
                        <small class="form-text text-muted">ชื่อเมนูที่จะแสดงให้ลูกค้าเห็น</small>
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">คำอธิบาย</label>
                        <textarea id="description" 
                                  name="description" 
                                  class="form-control" 
                                  rows="3"
                                  placeholder="คำอธิบายเมนู วัตถุดิบ รสชาติ...">{{ menu.description if edit else '' }}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="price" class="form-label">
                                    ราคา (บาท) <span class="required">*</span>
                                </label>
                                <input type="number" 
                                       id="price" 
                                       name="price" 
                                       class="form-control" 
                                       value="{{ menu.price if edit else '' }}"
                                       step="0.01"
                                       min="0"
                                       placeholder="0.00"
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="category" class="form-label">หมวดหมู่</label>
                                <input type="text" 
                                       id="category" 
                                       name="category" 
                                       class="form-control" 
                                       value="{{ menu.category if edit else '' }}"
                                       placeholder="เช่น อาหารจานเดียว, เครื่องดื่ม"
                                       list="categories">
                                <datalist id="categories">
                                    <option value="อาหารจานเดียว">
                                    <option value="ผัดและทอด">
                                    <option value="ต้มและแกง">
                                    <option value="ย่างและนึ่ง">
                                    <option value="ของหวาน">
                                    <option value="เครื่องดื่ม">
                                    <option value="น้ำผลไม้">
                                    <option value="อาหารเจ">
                                </datalist>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="prep_time" class="form-label">เวลาเตรียม (นาที)</label>
                                <input type="number" 
                                       id="prep_time" 
                                       name="prep_time" 
                                       class="form-control" 
                                       value="{{ menu.prep_time if edit else '' }}"
                                       min="0"
                                       placeholder="15">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check" style="margin-top: 35px;">
                                    <input type="checkbox" 
                                           id="is_active" 
                                           name="is_active" 
                                           class="form-check-input"
                                           {{ 'checked' if (edit and menu.is_active) or not edit else '' }}>
                                    <label for="is_active" class="form-check-label">
                                        เปิดใช้งาน (แสดงในเมนู)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload -->
                    <h5 class="mb-3 mt-4">รูปภาพเมนู</h5>
                    
                    <div class="form-group">
                        <div class="file-input-wrapper" onclick="document.getElementById('image').click()">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-0">คลิกเพื่อเลือกรูปภาพ</p>
                            <small class="text-muted">รองรับ JPG, PNG (ขนาดไม่เกิน 5MB)</small>
                            <input type="file" 
                                   id="image" 
                                   name="image" 
                                   accept="image/*"
                                   onchange="previewImage(this)">
                        </div>
                        
                        {% if edit and menu.image_url %}
                        <div class="mt-3">
                            <p class="form-label">รูปภาพปัจจุบัน:</p>
                            <img src="{{ menu.image_url }}" 
                                 alt="{{ menu.name }}" 
                                 class="image-preview"
                                 id="currentImage">
                        </div>
                        {% endif %}
                        
                        <img id="imagePreview" 
                             class="image-preview" 
                             style="display: none;">
                    </div>

                    <!-- Submit Buttons -->
                    <div class="form-group mt-4 pt-3 border-top">
                        <button type="submit" class="btn btn-submit me-3">
                            <i class="fas fa-save"></i>
                            {{ "บันทึกการแก้ไข" if edit else "เพิ่มเมนู" }}
                        </button>
                        <a href="{{ url_for('admin.menu_list') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> ยกเลิก
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="form-container">
                <h5 class="mb-3">ตัวอย่างเมนู</h5>
                <div class="card menu-preview">
                    <div class="card-img-top" style="height: 200px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                        <img id="previewMenuImage" 
                             src="{{ menu.image_url if edit and menu.image_url else '' }}" 
                             style="max-width: 100%; max-height: 100%; display: {{ 'block' if edit and menu.image_url else 'none' }};">
                        <div id="noImagePlaceholder" style="{{ 'display: none' if edit and menu.image_url else '' }}">
                            <i class="fas fa-image fa-3x text-muted"></i>
                            <p class="text-muted mt-2">ไม่มีรูปภาพ</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title" id="previewName">{{ menu.name if edit else "ชื่อเมนู" }}</h6>
                        <p class="card-text" id="previewDescription">{{ menu.description if edit else "คำอธิบายเมนู..." }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0 text-primary">
                                ฿<span id="previewPrice">{{ menu.price if edit else "0.00" }}</span>
                            </span>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i>
                                <span id="previewTime">{{ menu.prep_time if edit else "0" }}</span> นาที
                            </small>
                        </div>
                        <small class="text-muted">
                            หมวดหมู่: <span id="previewCategory">{{ menu.category if edit else "ไม่ระบุ" }}</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Real-time preview updates
    $('#name').on('input', function() {
        $('#previewName').text($(this).val() || 'ชื่อเมนู');
    });
    
    $('#description').on('input', function() {
        $('#previewDescription').text($(this).val() || 'คำอธิบายเมนู...');
    });
    
    $('#price').on('input', function() {
        const price = parseFloat($(this).val()) || 0;
        $('#previewPrice').text(price.toFixed(2));
    });
    
    $('#prep_time').on('input', function() {
        $('#previewTime').text($(this).val() || '0');
    });
    
    $('#category').on('input', function() {
        $('#previewCategory').text($(this).val() || 'ไม่ระบุ');
    });
    
    // Form validation
    $('#menuForm').on('submit', function(e) {
        let isValid = true;
        
        // Reset previous errors
        $('.form-control').removeClass('is-invalid');
        
        // Validate required fields
        if (!$('#name').val().trim()) {
            $('#name').addClass('is-invalid');
            isValid = false;
        }
        
        const price = parseFloat($('#price').val());
        if (isNaN(price) || price < 0) {
            $('#price').addClass('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง');
        }
    });
});

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            $('#imagePreview').attr('src', e.target.result).show();
            $('#previewMenuImage').attr('src', e.target.result).show();
            $('#noImagePlaceholder').hide();
            $('#currentImage').hide();
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}
</script>
{% endblock %}
